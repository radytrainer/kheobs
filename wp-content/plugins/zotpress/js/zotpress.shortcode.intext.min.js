jQuery(document).ready((function(){if(jQuery(".zp-Zotpress-InTextBib").length>0){var e=0;window.zpIntextCitations={},window.zpIntextCitationCount={},jQuery(".zp-Zotpress-InTextBib").each((function(e,r){var n=jQuery(r),i={};if(window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",n).text()]={},i.zpItemkey=!1,jQuery(".ZP_ITEM_KEY",n).text().trim().length>0&&(i.zpItemkey=jQuery(".ZP_ITEM_KEY",n).text()),i.zpStyle=!1,jQuery(".ZP_STYLE",n).text().trim().length>0&&(i.zpStyle=jQuery(".ZP_STYLE",n).text()),i.zpTitle=!1,jQuery(".ZP_TITLE",n).text().trim().length>0&&"no"!=jQuery(".ZP_TITLE",n).text().trim()&&(i.zpTitle=jQuery(".ZP_TITLE",n).text()),i.zpShowImages=!1,jQuery(".ZP_SHOWIMAGE",n).text().trim().length>0&&(i.zpShowImages=jQuery(".ZP_SHOWIMAGE",n).text().trim()),i.zpShowTags=!1,jQuery(".ZP_SHOWTAGS",n).text().trim().length>0&&(i.zpShowTags=!0),i.zpDownloadable=!1,jQuery(".ZP_DOWNLOADABLE",n).text().trim().length>0&&(i.zpDownloadable=!0),i.zpShowNotes=!1,jQuery(".ZP_NOTES",n).text().trim().length>0&&(i.zpShowNotes=!0),i.zpShowAbstracts=!1,jQuery(".ZP_ABSTRACT",n).text().trim().length>0&&(i.zpShowAbstracts=!0),i.zpCiteable=!1,jQuery(".ZP_CITEABLE",n).text().trim().length>0&&(i.zpCiteable=!0),i.zpTarget=!1,jQuery(".ZP_TARGET",n).text().trim().length>0&&(i.zpTarget=!0),i.zpURLWrap=!1,jQuery(".ZP_URLWRAP",n).text().trim().length>0&&(i.zpURLWrap=jQuery(".ZP_URLWRAP",n).text()),i.zpHighlight=!1,jQuery(".ZP_HIGHLIGHT",n).text().trim().length>0&&(i.zpHighlight=jQuery(".ZP_HIGHLIGHT",n).text()),i.zpSortBy=!1,jQuery(".ZP_SORTBY",n).text().trim().length>0&&(i.zpSortBy=jQuery(".ZP_SORTBY",n).text()),i.zpOrder=!1,jQuery(".ZP_ORDER",n).text().trim().length>0&&(i.zpOrder=jQuery(".ZP_ORDER",n).text()),i.zpUpdateNeeded=!1,jQuery(".ZP_UPDATENEEDED",n).text().trim().length>0&&"true"==jQuery(".ZP_UPDATENEEDED",n).text()&&(i.zpUpdateNeeded=!0),i.zpJSON=!1,jQuery(".ZP_JSON",n).text().trim().length>0&&(i.zpJSON=jQuery(".ZP_JSON",n).text().trim()),jQuery(".ZP_JSON",n).text().trim().length>0){var s=JSON.parse(decodeURIComponent(i.zpJSON));a(n,i.zpItemkey,s,i,!1)}else t(0,0,n,i,!1)}))}function t(t,r,n,i,s){console.log("zp: calling zp_get_items with update check?",s),console.log("zp: is an update needed?",i.zpUpdateNeeded),void 0!==t&&"false"!=t&&""!=t||(t=0),void 0!==r&&"false"!=r&&""!=r||(r=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",instance_id:n.attr("id"),type:"intext",item_key:i.zpItemkey,style:i.zpStyle,title:i.zpTitle,showimage:i.zpShowImages,showtags:i.zpShowTags,downloadable:i.zpDownloadable,shownotes:i.zpShowNotes,showabstracts:i.zpShowAbstracts,citeable:i.zpCiteable,target:i.zpTarget,urlwrap:i.zpURLWrap,highlight:i.zpHighlight,sortby:i.zpSortBy,order:i.zpOrder,update:s,request_update:i.zpUpdateNeeded,request_start:t,request_last:r,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(t){var r=jQuery.parseJSON(t);jQuery.each(r.data,(function(e,t){var a=(new DOMParser).parseFromString(t.bib,"text/html");r.data[e].bib=a.documentElement.textContent})),e+=r.data.length,s?console.log("zp: running update for items:",e,"->",r.data.length):console.log("zp: adding items:",e,"->",r.data.length),a(n,i.zpItemkey,r,i,s)},error:function(e){console.log("zp: Zotpress Error:"+e)}})}function a(e,a,r,n,i){if(!1===r||"error"==r.status){console.log("zp: Zotpress Error: "+r.data);var s="";jQuery("#"+r.instance+" .zp-List .zp-Entry").length>0&&(s=' class="hide"'),jQuery("#"+r.instance+" .zp-List").removeClass("loading").append("<p"+s+">Zotpress Error: "+r.data+"</p>")}else if(void 0!==r&&null!=r&&0!=parseInt(r)&&r.data.length>0){if(1==n.zpShowNotes)var p="";jQuery(e).parent();if(!1===i?jQuery("#"+r.instance+" .zp-List").addClass("used_cache"):!0===i&&(!jQuery("#"+r.instance+" .zp-List").hasClass("updating")&&jQuery("#"+r.instance+" .zp-Citation-Notes").length>0&&jQuery("#"+r.instance+" .zp-Citation-Notes").remove(),jQuery("#"+r.instance+" .zp-List").hasClass("updating")||jQuery("#"+r.instance+" .zp-List").addClass("updating")),function(e,t,a,r,n){var i=[];-1!=t.indexOf(";")?i=t.split(";"):i.push(t);var s={};jQuery.each(a,(function(e,t){s.hasOwnProperty(t.key)||(s[t.key]=t)})),a=s;var p={};jQuery.each(i,(function(t,r){var n="",i=jQuery(e).parent(),s="zp-InText-zp-ID-"+r.replace(/{/g,"-").replace(/}/g,"-").replace(/,/g,"_").replace(/:/g,"-")+"-wp"+jQuery(".ZP_POSTID",e).text(),o=0;jQuery("."+s,i).length>1&&(p.hasOwnProperty(s)?o=p[s]:p[s]=0);var l=JSON.parse(jQuery("."+s+":eq("+o+")",i).attr("rel").replace(/'/g,'"'));intext_citation_split=r.split("},{"),r=new Array,jQuery.each(intext_citation_split,(function(t,a){item_parts=a.split(":"),item_pages=!1,"np"!=l.pages&&(item_pages=l.pages.replaceAll("++",", "),item_pages=item_pages.split("--")[t],"np"==item_pages&&(item_pages=!1)),r[t]={api_user_id:item_parts[0].replace("{",""),key:item_parts[1].replace("}",""),post_id:jQuery(".ZP_POSTID",e).text(),pages:item_pages,class:s}}));var d=[];jQuery.each(r,(function(e,t){var n="",i="",s="";if(window.zpIntextCitations["post-"+t.post_id].hasOwnProperty(t.key)||(window.zpIntextCitations["post-"+t.post_id][t.key]=t,void 0===window.zpIntextCitationCount["post-"+t.post_id]&&(window.zpIntextCitationCount["post-"+t.post_id]=0),window.zpIntextCitationCount["post-"+t.post_id]++,window.zpIntextCitations["post-"+t.post_id][t.key].num=window.zpIntextCitationCount["post-"+t.post_id]),a.hasOwnProperty(t.key)){if(a[t.key].data.hasOwnProperty("creators")){var p=0,o=!1;if(jQuery.each(a[t.key].data.creators,(function(e,t){if("author"==t.creatorType)return o=!0,!1})),jQuery.each(a[t.key].data.creators,(function(e,t){if(o&&"author"!=t.creatorType)return!0;p++,0!=e&&p>1&&(i+=", "),t.hasOwnProperty("name")?i+=t.name:t.hasOwnProperty("lastName")&&(i+=t.lastName)})),-1==d.indexOf(i)&&(d[d.length]=i),i=i.split(", "),jQuery.isArray(i)&&i.length>2&&(""==l.etal||"default"==l.etal||"yes"==l.etal&&(i=i[0]+" <em>et al.</em>")),jQuery.isArray(i)&&i.length>1&&-1==i.indexOf("et al")){var y=" &amp; ";y="and"==l.and?" and ":"comma-and"==l.and?", and ":"comma-amp"==l.and?", &amp; ":"comma"==l.and?", ":" &amp; ";var u=i.join().replace(/,/g,", ");i=u.substring(0,u.lastIndexOf(", "))+y+i[i.length-1]}}else i+=a[t.key].data.title;s=a[t.key].meta.hasOwnProperty("parsedDate")?a[t.key].meta.parsedDate.substring(0,4):"n.d.",window.zpIntextCitations["post-"+t.post_id][t.key].intexttitle="title='"+JSON.stringify(i).replace("<em>et al.</em>","et al.").replace(/\"/g,"").replace("[","").replace("]","").replace(/â€™/g,"&#39;").replace(/'/g,"&#39;")+" ("+s+"). "+a[t.key].data.title+".' "}if(-1!=l.format.indexOf("%num%")){var c=l.format,z=window.zpIntextCitations["post-"+t.post_id][t.key].num;if(n=l.format.replace("%num%",z),0!=t.pages){var h="p. ";-1!=t.pages.indexOf("-")&&(h="pp. "),n=n.replace("%p%",h+t.pages)}else n=n.replace(", %p%","");r.length>1&&(e!=r.length-1&&(n=n.replace(")","")),0!=e&&(n=""==i?n.replace("(, ",""):n.replace("(",""))),l.brackets&&(n=(n=n.replace("(","")).replace(")",""))}else{c=l.format;n=(n=l.format.replace("%a%",i)).replace("%d%",s),n=0==t.pages?(n=n.replace(", %p%","")).replace("%p%",""):n.replace("%p%",t.pages),("(%a%, %d%, %p%)"==c||"(%a%, %d%)"==c)&&r.length>1&&(e!=r.length-1&&(n=n.replace(")","")),0!=e&&(n=""==i?n.replace("(, ",""):n.replace("(",""))),("%a%, %d%, %p%"==c||"%a%, %d%"==c)&&r.length>1&&0!=e&&""==i&&(n=n.replace(", ",""))}window.zpIntextCitations["post-"+t.post_id][t.key].hasOwnProperty("intexttitle")||(window.zpIntextCitations["post-"+t.post_id][t.key].intexttitle=""),n="<a rel='"+t.key+"' "+window.zpIntextCitations["post-"+t.post_id][t.key].intexttitle+"class='zp-ZotpressInText' href='#zp-ID-"+t.post_id+"-"+t.api_user_id+"-"+t.key+"'>"+n+"</a>","-1"!=l.format.indexOf("sup")&&(n="<sup>"+n+"</sup>"),r[e].intext=n,r[e].class=t.class;var m="0000",g="0000";a[t.key].meta.hasOwnProperty("parsedDate")&&(m=a[t.key].meta.parsedDate,g=a[t.key].meta.parsedDate.substring(0,4));var x="";a[t.key].meta.hasOwnProperty("creatorSummary")&&(x=a[t.key].meta.creatorSummary.replace(/['" ]/g,"-")),r[e].year=g,r[e].authdate=x+"-"+m}));var y="";l.brackets&&(y="[");var u="";l.brackets&&(u="]"),n=y,jQuery.each(r,(function(e,t){0!=e&&("comma"==l.separator?n+=", ":n+="; "),n+=t.intext})),n+=u,jQuery("."+s+":eq("+o+")",i).removeClass("loading").html(n),p.hasOwnProperty(s)&&p[s]++}))}(e,n.zpItemkey,r.data),p=function(e,t,a,r,n){var i="",s=!1,p=jQuery(".ZP_POSTID",e).text(),o=[],l=[],d={},y=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];if(jQuery.each(t.data,(function(a,u){var c="",z=jQuery("#"+t.instance+" .zp-List #zp-ID-"+p+"-"+u.library.id+"-"+u.key),h="0000",m="0000";u.meta.hasOwnProperty("parsedDate")&&(h=u.meta.parsedDate,m=u.meta.parsedDate.substring(0,4));var g="";u.meta.hasOwnProperty("creatorSummary")&&(g=u.meta.creatorSummary.replace(/['" ]/g,"-"));r.zpTitle&&(u.data.title.substr(10).replace(/['" ]/g,"-"),c+="<h3>"+m+"</h3>\n");var x=g+"-"+h,j="",Q=1,w=!1;if(l.includes(x)&&(w=!0,Q=l.filter((e=>e===x)).length,j=y[Q-1],Q+=1),l.push(x),d[x+"-"+(Q-1)]={itemkey:u.key,authDateStrDisAlpha:j},c+="<div id='zp-ID-"+jQuery(".ZP_POSTID",e).text()+"-"+u.library.id+"-"+u.key+"'",c+=" data-zp-author-date='"+g+"-"+h+"'",c+=" data-zp-date-author='"+h+"-"+g+"'",c+=" class='zp-Entry zpSearchResultsItem zp-Num-"+window.zpIntextCitations["post-"+p][u.key].num,w){if(2==Q){var _=d[x+"-0"].itemkey,I=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].year+"b";window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].intexttitle=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].intexttitle.replaceAll(m,I),window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].intext=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].intext.replaceAll(m,I),jQuery.each(t.data,(function(e,a){a.key==_&&-1==t.data[e].bib.indexOf(I)&&(t.data[e].bib=t.data[e].bib.replace(m,I))})),jQuery("."+window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][_].class).each((function(){jQuery('a[rel="'+_+'"',this).text(jQuery('a[rel="'+_+'"',this).text().replaceAll(m,I)),jQuery('a[rel="'+_+'"',this).attr("title",jQuery('a[rel="'+_+'"',this).attr("title").replaceAll(m,I))}));var f=jQuery("#zp-ID-"+p+"-"+u.library.id+"-"+_);-1==(P=jQuery("#zp-ID-"+p+"-"+u.library.id+"-"+_+" .csl-entry")).html().indexOf(I)&&P.html(P.html().replace(m,I)),f.addClass("zp_disam").attr("data-zp-author-date",g+"-"+I).attr("data-zp-date-author",I+"-"+g)}I=m+j;window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][u.key].intexttitle=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][u.key].intexttitle.replaceAll(m,I),window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][u.key].intext=window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][u.key].intext.replaceAll(m,I),-1==u.bib.indexOf(I)&&(u.bib=u.bib.replace(m,I)),-1==t.data[a].bib.indexOf(I)&&(t.data[a].bib=t.data[a].bib.replace(m,I)),jQuery("."+window.zpIntextCitations["post-"+jQuery(".ZP_POSTID",e).text()][u.key].class).each((function(){jQuery('a[rel="'+u.key+'"',this).text(jQuery('a[rel="'+u.key+'"',this).text().replaceAll(m,I)),jQuery('a[rel="'+u.key+'"',this).attr("title",jQuery('a[rel="'+u.key+'"',this).attr("title").replaceAll(m,I))}));var P;f=jQuery("#zp-ID-"+p+"-"+u.library.id+"-"+u.key);(P=jQuery("#zp-ID-"+p+"-"+u.library.id+"-"+u.key+" .csl-entry")).html()&&-1==P.html().indexOf(I)&&P.html(P.html().replace(m,I)),f.addClass("zp_disam").attr("data-zp-author-date",g+"-"+I).attr("data-zp-date-author",I+"-"+g)}!0===n&&(c+=" zp_updated"),jQuery("#"+t.instance+" .ZP_SHOWIMAGE").text().trim().length>0&&u.hasOwnProperty("image")?(c+=" zp-HasImage'>\n",c+="<div id='zp-Citation-"+u.key+"' class='zp-Entry-Image hasImage' rel='"+u.key+"'>\n","image"==r.zpURLWrap&&""!=u.data.url&&(c+="<a href='"+u.data.url+"'",r.zpTarget&&(c+=" target='_blank'"),c+=">"),c+="<img class='thumb' src='"+u.image[0]+"' alt='image' />\n","image"==r.zpURLWrap&&""!=u.data.url&&(c+="</a>"),c+="</div>\x3c!-- .zp-Entry-Image --\x3e\n"):c+="'>\n";var b=function(e,t,a){var r={order:0,item_key:""};if(/csl-left-margin/i.test(t.bib)){var n=jQuery.parseHTML(t.bib),i=jQuery(".csl-left-margin",n).text();i=i.replace(i.match(/\d+/)[0],window.zpIntextCitations["post-"+a][t.key].num),jQuery(".csl-left-margin",n).text(i),t.bib=jQuery("<div>").append(n).html(),r.order=window.zpIntextCitations["post-"+a][t.key].num,r.key=t.key}else if(jQuery("#"+e+" .ZP_FORCENUM").text().length>0&&"1"==jQuery("#"+e+" .ZP_FORCENUM").text()){n=jQuery.parseHTML(t.bib);jQuery(".csl-entry",n).prepend('<div class="csl-left-margin" style="display: inline;">'+window.zpIntextCitations["post-"+a][t.key].num+". </div>"),t.bib=jQuery("<div>").append(n).html(),r.order=window.zpIntextCitations["post-"+a][t.key].num,r.key=t.key}return{itemNumOrder:r,item:t}}(t.instance,u,p);u=b.item,o[b.itemNumOrder.order]=b.itemNumOrder.key,/csl-left-margin/i.test(u.bib)&&(s=!0),c+=u.bib,1==r.zpShowAbstracts&&u.data.hasOwnProperty("abstractNote")&&u.data.abstractNote.length>0&&(c+="<p class='zp-Abstract'><span class='zp-Abstract-Title'>Abstract:</span> "+u.data.abstractNote+"</p>\n"),1==r.zpShowTags&&u.data.hasOwnProperty("tags")&&u.data.tags.length>0&&(c+="<p class='zp-Zotpress-ShowTags'><span class='title'>Tags:</span> ",jQuery.each(u.data.tags,(function(e,t){c+="<span class='tag'>"+t.tag+"</span>",e!=u.data.tags.length-1&&(c+="<span class='separator'>,</span> ")})),c+="</p>\n"),c+="</div>\n",1==r.zpShowNotes&&u.hasOwnProperty("notes")&&(i+=u.notes),z.length>0&&!0===n?z.replaceWith(jQuery(c)):0==z.length?jQuery("#"+t.instance+" .zp-List").append(c):z.replaceWith(jQuery(c))})),s&&!1===n)if(0==jQuery("#"+t.instance+" .zp-List .zp-Entry").length);else for(var u=1;u<o.length;u++){window.zpIntextCitations["post-"+p][o[u]];var c=jQuery("#zp-ID-"+p+"-"+window.zpIntextCitations["post-"+p][o[u]].api_user_id+"-"+o[u]);jQuery("#"+t.instance+" .zp-List").append(c)}return i}(e,r,n.zpItemkey,n,i),!1===i&&jQuery("#"+r.instance+" .zp-SEO-Content .zp-Entry").unwrap(),1==n.zpShowNotes&&p.length>0&&(p="<div class='zp-Citation-Notes'>\n<h4>Notes</h4>\n<ol>\n"+p,p+="</ol>\n</div>\x3c!-- .zp-Citation-Notes --\x3e\n\n",jQuery("#"+r.instance).append(p)),0!=r.meta.request_next&&"false"!=r.meta.request_next)t(r.meta.request_next,r.meta.request_last,e,n,i);else if(jQuery("#"+r.instance+" .zp-List").removeClass("loading"),jQuery("#"+r.instance+" .zp-List").hasClass("updating"))if(r.updateneeded)console.log("zp: update needed"),n.zpUpdateNeeded=!0,t(0,0,e,n,!0);else{var o=n.zpSortBy,l=n.zpOrder;if(-1!==["author","date"].indexOf(o)&&0==jQuery("#"+r.instance+" .zp-List .csl-left-margin").length){var d="zp-author-date";"date"==o&&(d="zp-date-author"),jQuery("#"+r.instance+" .zp-List div.zp-Entry").sort((function(e,t){var a=jQuery(e).data(d).toLowerCase(),r=jQuery(t).data(d).toLowerCase();return a>r?"asc"==l?1:-1:a<r?"asc"==l?-1:1:0})).detach().appendTo("#"+r.instance+" .zp-List")}else-1==["author","date"].indexOf(o)&&0!=jQuery("#"+r.instance+" .zp-List .csl-left-margin").length&&(console.log("zp: re-sorting numbered citations in bibliography"),jQuery("#"+r.instance+" .zp-List div.zp-Entry").sort((function(e,t){var a=parseInt(jQuery(".csl-left-margin",e).text()),r=parseInt(jQuery(".csl-left-margin",t).text());return a>r?"asc"==l?1:-1:a<r?"asc"==l?-1:1:0})).detach().appendTo("#"+r.instance+" .zp-List"));console.log("zp: done"),console.log("---")}else t(0,0,e,n,!0)}else{console.log("zp: no items"),console.log("---");var y=e.attr("class");y=y.replace("zp-Zotpress zp-Zotpress-InTextBib zp-Post-",""),jQuery("#post-"+y).length>0?jQuery("#post-"+y+" .zp-InText-Citation").removeClass("loading").remove():jQuery("#"+e.attr("id")).parent().find(".zp-InText-Citation").removeClass("loading").remove(),jQuery("#"+e.attr("id")+" .zp-List").removeClass("loading"),jQuery("#"+e.attr("id")+" .zp-List").append("<p>There are no citations to display.</p>\n")}}}));